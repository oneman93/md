<!-- 
    See documentation md.htm.md
-->
<html lang="en-us">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
        <script type="module" src="https://cdn.jsdelivr.net/gh/zerodevx/zero-md@2/dist/zero-md.min.js"></script>

        <!-- Todo: convert to local cdn -->
        <!-- <script src="./md/zero-md-main/dist/zero-md.min.js"></script> -->

        <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"> -->

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">


        <link rel="stylesheet" href="md-main.css" />
        <link rel="stylesheet" href="github.css" />
        
        <!-- Conditionally load moh93-custom.css only for moh93 project -->
        <script>
            (function() {
                try {
                    // Determine if this is moh93 project
                    var queryString = window.location.search.substring(1);
                    var srcParamIndex = queryString.indexOf("src=");
                    var afterSrc = srcParamIndex >= 0 ? queryString.substring(srcParamIndex + 4) : "";
                    var isFullUrl = afterSrc.indexOf("http://") === 0 || afterSrc.indexOf("https://") === 0 || afterSrc.indexOf("https%3A") === 0;
                    var _productionHostname = "home.moh93.com";
                    window._isMoh93Project = window.location.hostname.startsWith(_productionHostname) || isFullUrl;
                    
                    // Only load moh93-custom.css for moh93 project
                    if (window._isMoh93Project) {
                        var link = document.createElement("link");
                        link.rel = "stylesheet";
                        link.href = "./moh93-custom.css";
                        document.head.appendChild(link);
                    }
                } catch (e) {
                    console.error('Error loading moh93-custom.css:', e);
                }
            })();
        </script>

        <!-- These two stylesheets were created by zero-md dynamically under shadow root: #shadow-root
        I copied here manually to use with <zero-md-clone></zero-md-clone> -->

        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">

        <!-- fontawsome -->
        <script src="https://kit.fontawesome.com/33b67b9684.js" crossorigin="anonymous"></script>

        <meta charset="utf-8">
        <title>md.htm</title>
        <link rel="icon" type="image/x-icon" href="/md/images/favicon.png">

        <!-- photo swipe -->
        <script type="module">
            import PhotoSwipeLightbox from './dist/photoswipe-lightbox.esm.js';

            const options = {
                gallery: '#mdcontainer',
                children: 'a.photoswipe',
                pswpModule: () => import('./dist/photoswipe.esm.js')
            };
            window.photoSwipeLightbox = new PhotoSwipeLightbox(options);
            window.photoSwipeLightbox.on('uiRegister', function () {
                window.photoSwipeLightbox.pswp.ui.registerElement({
                    name: 'custom-caption',
                    order: 9,
                    isButton: false,
                    appendTo: 'root',
                    html: 'Caption text',
                    onInit: (el, pswp) => {
                        window.photoSwipeLightbox.pswp.on('change', () => {
                            // Check if currSlide exists before accessing its properties
                            if (window.photoSwipeLightbox.pswp && window.photoSwipeLightbox.pswp.currSlide && window.photoSwipeLightbox.pswp.currSlide.data) {
                                const currSlideElement = window.photoSwipeLightbox.pswp.currSlide.data.element;
                                let captionHTML = '';
                                if (currSlideElement) {
                                    const hiddenCaption = currSlideElement.querySelector('.hidden-caption-content');
                                    if (hiddenCaption) {
                                        // get caption from element with class hidden-caption-content
                                        captionHTML = hiddenCaption.innerHTML;
                                    } else {
                                        // get caption from alt attribute
                                        const img = currSlideElement.querySelector('img');
                                        if (img) {
                                            captionHTML = img.getAttribute('title') || '';
                                        }
                                    }
                                }
                                el.innerHTML = captionHTML || '';
                            }
                        });
                    }
                });
            });
            // PhotoSwipe will be initialized after images are wrapped
            // Event delegation will handle clicks on dynamically added links
        </script>

        <link rel="stylesheet" href="./dist/photoswipe.css">

        <!-- jspdf -->
        <script src="./dist/jspdf/jspdf-251.js"></script>
        <script src="./dist/jspdf/html2canvas.js"></script>

        <!-- Mermaid -->
        <script defer src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

        <!-- Production-specific custom functions -->
        <script src="./moh93-custom.js"></script>

    </head>

    <body>
        <div class="top-menu-wrapper d-flex justify-content-between">
            <DIV id="divLeft" class="top-menu-left">
                <input id="inputSearch" type="text" placeholder="type to search..." />
                <span id="versionDisplay" class="version-display" style="margin-left: 10px; font-weight: bold; color: #6c757d;"></span>
                <button id="btnReset" type="button" class="btn btn-primary btn-sm">Reset</button>
                <button id="btnHome" type="button" class="btn btn-danger btn-sm">
                    <span style="font-size: 1em;color:white;"><i class="fa-solid fa-house"></i></span>
                    Go Home</button>
                
                <!-- Hamburger menu button (visible on mobile only) -->
                <button id="btnHamburger" type="button" class="btn btn-secondary btn-sm hamburger-btn" aria-label="Toggle menu">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </DIV>
            
            <!-- Desktop menu items (hidden on mobile) -->
            <DIV id="divRight" class="top-menu-right desktop-menu">
                <button id="btnExit" type="button" class="btn btn-warning btn-sm" style="margin-left: 10px; display: none;">
                    Exit
                </button>
                <a id="btnLocalVideos" type="button" class="btn btn-info btn-sm"
                    href="https://laureateaus-my.sharepoint.com/personal/matthew_oh_torrens_edu_au/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fmatthew%5Foh%5Ftorrens%5Fedu%5Fau%2FDocuments%2FLocalVideos&view=0">
                    Local Videos</a>
                <button id="btnWrapIt" type="button" class="btn btn-primary btn-sm">Wrap with md.htm</button>
                <button id="btnCopy" type="button" class="btn btn-primary btn-sm" onclick="CopyHTMLToClipboard()">
                    Copy</button>
                <button id="btnCopy2Conf" type="button" class="btn btn-primary btn-sm" onclick="CopyHTMLToClipboard2Conf()">
                    Copy2Conf</button>
                <button id="btnCopyPath" type="button" class="btn btn-secondary btn-sm" onclick="CopyFilePath()">
                    Copy Md Path</button>
                <button id="btnImageFolder" type="button" class="btn btn-primary btn-sm invisible">
                    <span style=" font-size: 1em;color:white;"><i class="fa-solid fa-folder"></i></span>
                    Copy</button>
                <button id="btnPDF" type="button" class="btn btn-dark btn-sm">PDF</button>
                <button id="btnH1Only" type="button" class="btn btn-primary btn-sm">Show H1 Only</button>
            </DIV>
            
            <!-- Mobile menu overlay (hidden by default) -->
            <div id="mobileMenuOverlay" class="mobile-menu-overlay">
                <div class="mobile-menu-content">
                    <button id="btnMobileReset" type="button" class="btn btn-primary btn-sm btn-block">Reset</button>
                    <button id="btnMobileHome" type="button" class="btn btn-danger btn-sm btn-block">
                        <span style="font-size: 1em;color:white;"><i class="fa-solid fa-house"></i></span>
                        Go Home</button>
                    <button id="btnMobileExit" type="button" class="btn btn-warning btn-sm btn-block" style="display: none;">
                        Exit
                    </button>
                    <a id="btnMobileLocalVideos" type="button" class="btn btn-info btn-sm btn-block"
                        href="https://laureateaus-my.sharepoint.com/personal/matthew_oh_torrens_edu_au/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fmatthew%5Foh%5Ftorrens%5Fedu%5Fau%2FDocuments%2FLocalVideos&view=0">
                        Local Videos</a>
                    <button id="btnMobileWrapIt" type="button" class="btn btn-primary btn-sm btn-block">Wrap with md.htm</button>
                    <button id="btnMobileCopy" type="button" class="btn btn-primary btn-sm btn-block" onclick="CopyHTMLToClipboard()">
                        Copy</button>
                    <button id="btnMobileCopy2Conf" type="button" class="btn btn-primary btn-sm btn-block" onclick="CopyHTMLToClipboard2Conf()">
                        Copy2Conf</button>
                    <button id="btnMobileCopyPath" type="button" class="btn btn-secondary btn-sm btn-block" onclick="CopyFilePath()">
                        Copy Md Path</button>
                    <button id="btnMobileImageFolder" type="button" class="btn btn-primary btn-sm btn-block invisible">
                        <span style=" font-size: 1em;color:white;"><i class="fa-solid fa-folder"></i></span>
                        Copy</button>
                    <button id="btnMobilePDF" type="button" class="btn btn-dark btn-sm btn-block">PDF</button>
                    <button id="btnMobileH1Only" type="button" class="btn btn-primary btn-sm btn-block">Show H1 Only</button>
                </div>
            </div>

        </div>

        <div id="mdcontainer" style="width:70%; margin:0 auto; margin-top: 50px;">
            <!-- shadow dom will be cloned here -->
        </div>

        <!-- Toast notification container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Floating Table Navigation -->
        <div class="table-nav-container" id="tableNavContainer">
            <div class="table-nav-title">Tables</div>
            <div id="tableNavButtons"></div>
        </div>



    </body>

    <script>
        // Local storage variables
        var _clickHistory = "ls-click-history";
        var _expandedNth = "ls-expanded-nth";
        var _searchText = "ls-search-text";
        var _isWrapped = "ls-is-wrapper";

        // Production hostname
        var _productionHostname = "home.moh93.com";
        
        // isMoh93Project is already defined in the head script section

        // File paths
        var _indexMdFile = '../_work-index.md';

        var specialElementHandlers = {
            '#editor': function (element, renderer) {
                return true;
            }
        };

        // Toast notification function
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Remove toast after 6 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 6000);
        }

        //https://stackoverflow.com/questions/12982156/select-copy-text-using-javascript-or-jquery
        function CopyHTMLToClipboard() {
            //Before we copy, we are going to select the text.
            var text = document.getElementById('mdcontainer');
            var selection = window.getSelection();
            var range = document.createRange();
            range.selectNodeContents(text);
            selection.removeAllRanges();
            selection.addRange(range);
            //add to clipboard.
            document.execCommand('copy');
            document.execCommand("UnSelect", true);
            showToast('HTML content copied to clipboard!');
        }

        function CopyHTMLToClipboard2Conf() {
            try {
                var container = document.getElementById('mdcontainer');
                if (!container) {
                    showToast('Container not found', 'error');
                    return;
                }

                // Clone the container to avoid modifying the original
                var clone = container.cloneNode(true);
                
                // Find and remove content from "Do not copy from here" onwards
                // Look for h1, h2, or h3 elements containing the stop marker text
                var stopMarkerTexts = [
                    'Do not copy from here',
                    'Do not copy from here ---'
                ];
                
                var foundStopHeading = null;
                
                // Find the heading element that contains the stop marker
                var allHeadings = clone.querySelectorAll('h1, h2, h3');
                for (var i = 0; i < allHeadings.length; i++) {
                    var heading = allHeadings[i];
                    var headingText = (heading.textContent || heading.innerText || '').trim();
                    
                    // Check if this heading contains any of the stop marker texts
                    for (var j = 0; j < stopMarkerTexts.length; j++) {
                        if (headingText.includes(stopMarkerTexts[j])) {
                            foundStopHeading = heading;
                            break;
                        }
                    }
                    if (foundStopHeading) break;
                }
                
                // If we found the stop heading, remove it and everything after it
                if (foundStopHeading) {
                    // Find the parent h1-wrapper div (content is wrapped in div.h1-wrapper)
                    var h1Wrapper = foundStopHeading.closest('.h1-wrapper');
                    
                    if (h1Wrapper) {
                        // Find the parent container of the h1-wrapper
                        var parent = h1Wrapper.parentNode;
                        
                        if (parent) {
                            // Get all h1-wrapper siblings
                            var siblings = Array.from(parent.children);
                            var wrapperIndex = siblings.indexOf(h1Wrapper);
                            
                            // Remove this h1-wrapper and all following h1-wrapper siblings
                            for (var k = siblings.length - 1; k >= wrapperIndex; k--) {
                                parent.removeChild(siblings[k]);
                            }
                        } else {
                            // If no parent, remove the wrapper itself
                            h1Wrapper.parentNode.removeChild(h1Wrapper);
                        }
                    } else {
                        // Fallback: if no h1-wrapper found, try to remove from heading's parent
                        var parent = foundStopHeading.parentNode;
                        if (parent) {
                            var siblings = Array.from(parent.children);
                            var headingIndex = siblings.indexOf(foundStopHeading);
                            
                            // Remove the heading and all following siblings
                            for (var k = siblings.length - 1; k >= headingIndex; k--) {
                                parent.removeChild(siblings[k]);
                            }
                        }
                    }
                }
                
                // Remove links to md files containing 'mermaid' or 'cursor'
                var links = clone.querySelectorAll('a[href]');
                links.forEach(function(link) {
                    var href = link.getAttribute('href') || '';
                    var hrefLower = href.toLowerCase();
                    
                    // Check if href contains 'mermaid' or 'cursor' and points to an md file
                    if ((hrefLower.includes('mermaid') || hrefLower.includes('cursor')) && 
                        (hrefLower.includes('.md') || hrefLower.includes('mermaid') || hrefLower.includes('cursor'))) {
                        // Replace link with just its text content
                        var textNode = document.createTextNode(link.textContent || link.innerText);
                        if (link.parentNode) {
                            link.parentNode.replaceChild(textNode, link);
                        }
                    }
                });
                
                // Create a temporary div to hold the filtered content
                var tempDiv = document.createElement('div');
                tempDiv.style.position = 'fixed';
                tempDiv.style.left = '-9999px';
                tempDiv.innerHTML = clone.innerHTML;
                document.body.appendChild(tempDiv);
                
                // Select and copy
                var selection = window.getSelection();
                var range = document.createRange();
                range.selectNodeContents(tempDiv);
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Copy to clipboard
                document.execCommand('copy');
                document.execCommand("UnSelect", true);
                
                // Clean up
                document.body.removeChild(tempDiv);
                
                showToast('Content copied to clipboard (excluding mermaid/cursor links and stop section)!');
            } catch (error) {
                console.error('Copy error:', error);
                showToast('Error copying content', 'error');
            }
        }

        // Copy file path function
        function CopyFilePath() {
            const currentPath = window.location.href;
            navigator.clipboard.writeText(currentPath).then(() => {
                showToast(`File path copied: ${currentPath}`);
            }).catch(() => {
                showToast('Failed to copy path', 'error');
            });
        }

        // Table Navigation Functions
        function createTableNavigation() {
            const container = document.getElementById('tableNavContainer');
            const buttonsContainer = document.getElementById('tableNavButtons');

            // Clear existing buttons
            buttonsContainer.innerHTML = '';

            // Find all H1 and H2 elements that have tables as siblings or descendants
            const headingsWithTables = [];

            // Check H1 elements
            document.querySelectorAll('h1').forEach((heading, index) => {
                if (hasTableAfterHeading(heading)) {
                    // Add ID if it doesn't exist
                    if (!heading.id) {
                        heading.id = `table-heading-h1-${index}`;
                    }
                    headingsWithTables.push({
                        element: heading,
                        text: heading.textContent.trim(),
                        id: heading.id,
                        level: 1
                    });
                }
            });

            // Check H2 elements
            document.querySelectorAll('h2').forEach((heading, index) => {
                if (hasTableAfterHeading(heading)) {
                    // Add ID if it doesn't exist
                    if (!heading.id) {
                        heading.id = `table-heading-h2-${index}`;
                    }
                    
                    // Find the parent h1 title for h2 headings
                    var h1Title = '';
                    var h1Wrapper = heading.closest('.h1-wrapper');
                    if (h1Wrapper) {
                        var h1Element = h1Wrapper.querySelector('h1');
                        if (h1Element) {
                            h1Title = h1Element.textContent.trim();
                        }
                    }
                    
                    // Fallback: if no h1 found in wrapper, find the previous h1 sibling
                    if (!h1Title) {
                        var prevSibling = heading.previousElementSibling;
                        while (prevSibling) {
                            if (prevSibling.tagName === 'H1') {
                                h1Title = prevSibling.textContent.trim();
                                break;
                            }
                            prevSibling = prevSibling.previousElementSibling;
                        }
                    }
                    
                    // Create text as "h1Title-h2Title" format
                    var h2Title = heading.textContent.trim();
                    var displayText = h1Title ? (h1Title + ' - ' + h2Title) : h2Title;
                    
                    headingsWithTables.push({
                        element: heading,
                        text: displayText,
                        id: heading.id,
                        level: 2
                    });
                }
            });

            // Create buttons for each heading with tables
            if (headingsWithTables.length > 0) {
                headingsWithTables.forEach(heading => {
                    const button = document.createElement('button');
                    button.className = 'table-nav-button';
                    button.textContent = heading.text;
                    button.onclick = () => scrollToElement(heading.id);
                    buttonsContainer.appendChild(button);
                });

                // Show the container
                container.classList.add('show');
            } else {
                // Hide the container if no tables found
                container.classList.remove('show');
            }
        }

        function hasTableAfterHeading(heading) {
            let nextElement = heading.nextElementSibling;

            // Check the next few siblings for a table
            let checkCount = 0;
            while (nextElement && checkCount < 10) {
                if (nextElement.tagName === 'TABLE') {
                    return true;
                }

                // Also check if there's a table inside the next element
                if (nextElement.querySelector && nextElement.querySelector('table')) {
                    return true;
                }

                // Stop if we hit another heading
                if (nextElement.tagName === 'H1' || nextElement.tagName === 'H2' || nextElement.tagName === 'H3') {
                    break;
                }

                nextElement = nextElement.nextElementSibling;
                checkCount++;
            }

            return false;
        }

        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // Calculate offset for fixed header (search-wrapper)
                const searchWrapper = document.querySelector('.search-wrapper');
                const offset = searchWrapper ? searchWrapper.offsetHeight + 20 : 80; // Add 20px padding
                
                // Get the position of the element
                const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = elementPosition - offset;

                // Scroll to the position with offset
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                // Optional: highlight the heading briefly
                element.style.backgroundColor = '#fff3cd';
                setTimeout(() => {
                    element.style.backgroundColor = '';
                }, 2000);
            }
        }

        /**
         * Gets a query parameter value from the URL.
         * Parses all query parameters and returns the value for the specified key.
         * Returns empty string if the parameter is not found.
         * 
         * Example:
         * - URL: "?src=page.md&other=value"
         *   getQueryParam("src") returns: "page.md"
         *   getQueryParam("other") returns: "value"
         *   getQueryParam("missing") returns: ""
         * 
         * @param {string} key - The query parameter key
         * @returns {string} The value of the query parameter, or empty string if not found
         */
        function getQueryParam(key) {
            var query = window.location.search.substring(1);
            var key_values = query.split("&");
            var params = {};
            key_values.map(function (key_val) {
                var key_val_arr = key_val.split("=");
                var paramKey = key_val_arr[0];
                var paramValue = key_val_arr.length > 1 ? key_val_arr.slice(1).join("=") : "";
                // Decode the parameter value
                try {
                    params[paramKey] = decodeURIComponent(paramValue);
                } catch (e) {
                    params[paramKey] = paramValue;
                }
            });
            if (typeof params[key] != "undefined") {
                return params[key];
            }
            return "";
        }

        // Prevent chrome auto page refresh
        // https://stackoverflow.com/questions/58118286/how-to-prevent-page-refresh-or-default-prompt-box-in-chrome
        // 2/11/23, Disabled to remove Leave Site? popup.
        // https://superuser.com/questions/705307/how-can-i-disable-are-you-sure-you-want-to-leave-this-page-popups-in-chrome

        // window.addEventListener("beforeunload", function (e) {
        //     // Do something
        //     console.log('chrome auto refresh blocked.');
        //     e.preventDefault();
        // }, false);

        // Function to load and display version from local-version-history.md
        function loadVersion() {
            var versionDisplay = document.getElementById('versionDisplay');
            if (!versionDisplay) return;

            // Try to fetch local-version-history.md with cache-busting parameter
            var cacheBuster = '?t=' + new Date().getTime();
            fetch('local-version-history.md' + cacheBuster)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Version file not found');
                    }
                    return response.text();
                })
                .then(function(text) {
                    // Extract the first line (version)
                    var lines = text.split('\n');
                    var version = '';
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i].trim();
                        // Look for version header like # v1.0.0 or # mdv1.0.0
                        if (line.startsWith('# v') || line.startsWith('#v') || line.startsWith('# localv') || line.startsWith('#localv')) {
                            version = line.replace(/^#\s*/, ''); // Remove # and any space
                            break;
                        }
                    }
                    if (version) {
                        versionDisplay.textContent = version;
                        // Also update the version display after home icon if it exists (for root pages)
                        var versionDisplayAfterHome = document.querySelector('.version-display-after-home');
                        if (versionDisplayAfterHome) {
                            versionDisplayAfterHome.textContent = version;
                        }
                    } else {
                        versionDisplay.textContent = 'v?.?.?';
                        var versionDisplayAfterHome = document.querySelector('.version-display-after-home');
                        if (versionDisplayAfterHome) {
                            versionDisplayAfterHome.textContent = 'v?.?.?';
                        }
                    }
                })
                .catch(function(error) {
                    console.log('Could not load version:', error);
                    versionDisplay.textContent = '';
                });
        }

        window.onload = function () {
            // Load version on page load
            loadVersion();

            md = document.createElement("zero-md")
            // Use getQueryParamSuffix for production or when src contains a full URL (may have query params)
            // Use getQueryParam for simple relative paths in localhost
            var queryString = window.location.search.substring(1);
            var srcParamIndex = queryString.indexOf("src=");
            var afterSrc = srcParamIndex >= 0 ? queryString.substring(srcParamIndex + 4) : "";
            // Check if src value starts with http://, https://, or URL-encoded version
            var isFullUrl = afterSrc.indexOf("http://") === 0 || afterSrc.indexOf("https://") === 0 || afterSrc.indexOf("https%3A") === 0;
            var srcValue = (window.location.hostname.startsWith(_productionHostname) || isFullUrl)
                ? getQueryParamSuffix("src") 
                : getQueryParam("src");
            
            // Ensure relative paths without ./ or ../ are treated as relative to md.htm's directory
            // If srcValue doesn't start with http://, https://, ../, ./, or /, prepend ../
            if (srcValue && 
                !srcValue.startsWith('http://') && 
                !srcValue.startsWith('https://') && 
                !srcValue.startsWith('../') && 
                !srcValue.startsWith('./') && 
                !srcValue.startsWith('/')) {
                // Paths like "SQLQueries/Wisenet/file.md" should be "../SQLQueries/Wisenet/file.md"
                // relative to md/ directory where md.htm is located
                srcValue = '../' + srcValue;
            }
            
            md.setAttribute("src", srcValue)
            md.setAttribute("no-shadow", "")
            document.getElementById("mdcontainer").append(md)

            // my code trial begins ----
            const app = document.querySelector('zero-md')
            
            /**
             * Display restricted document message
             */
            function showRestrictedMessage() {
                const mdcontainer = document.getElementById('mdcontainer');
                if (mdcontainer) {
                    mdcontainer.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #dc3545;">
                            <h2 style="color: #dc3545; margin-bottom: 20px;">Access Restricted</h2>
                            <p style="font-size: 18px;">The requested document is restricted.</p>
                        </div>
                    `;
                }
            }
            
            const run = async () => {

                const _url = window.location.href;
                console.log('app.src: ', app.src);

                if (app.src == '') {
                    app.src = _indexMdFile;
                }
                
                // Listen for zero-md error events (including 403 Forbidden from server)
                app.addEventListener('zero-md-error', (ev) => {
                    console.log('zero-md-error event fired:', ev.detail);
                    if (ev.detail.status === 403) {
                        console.log('âŒ Document access denied by server (403 Forbidden)');
                        console.log('Server response indicates: The requested document is restricted.');
                        showRestrictedMessage();
                    } else if (ev.detail.status) {
                        console.error('âŒ Error loading markdown - HTTP status:', ev.detail.status, ev.detail.msg);
                    } else {
                        console.error('âŒ Error loading markdown:', ev.detail.msg);
                    }
                });
                
                // Check response headers for access control debugging (when 403 occurs)
                app.addEventListener('zero-md-error', async (ev) => {
                    if (ev.detail.status === 403) {
                        // Try to fetch the same URL to check response headers
                        try {
                            const response = await fetch(app.src, { method: 'HEAD' });
                            const s3Bucket = response.headers.get('X-S3-Bucket');
                            const s3Key = response.headers.get('X-S3-Key');
                            const accessHeader = response.headers.get('X-Document-Access');
                            const metadataKeys = response.headers.get('X-Document-Metadata-Keys');
                            const documentLevelValue = response.headers.get('X-Document-Level-Value');
                            
                            console.log('ðŸ” Debug - Access denied details:');
                            if (s3Bucket && s3Key) {
                                console.log('  ðŸ“¦ Reading from S3:');
                                console.log('    Bucket:', s3Bucket);
                                console.log('    Key:', s3Key);
                            }
                            console.log('  Reason:', accessHeader || 'unknown');
                            if (metadataKeys) {
                                console.log('  Metadata keys found:', metadataKeys);
                                if (!metadataKeys.toLowerCase().includes('documentlevel')) {
                                    console.warn('  âš ï¸ documentLevel key NOT found in metadata');
                                    console.warn('  âš ï¸ Available keys:', metadataKeys);
                                }
                            } else {
                                console.log('  No metadata keys found (metadata not parsed)');
                            }
                            if (documentLevelValue) {
                                console.log('  documentLevel value:', documentLevelValue);
                            }
                        } catch (e) {
                            console.error('Error fetching debug headers:', e);
                        }
                    }
                });
                
                // Also log S3 info on successful loads
                app.addEventListener('zero-md-rendered', async (ev) => {
                    try {
                        const response = await fetch(app.src, { method: 'HEAD' });
                        const s3Bucket = response.headers.get('X-S3-Bucket');
                        const s3Key = response.headers.get('X-S3-Key');
                        if (s3Bucket && s3Key) {
                            console.log('âœ… Document loaded from S3:');
                            console.log('  Bucket:', s3Bucket);
                            console.log('  Key:', s3Key);
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                });

                var isRootPage = false;
                // Use fnIsRootPage() function which handles both moh93 and non-moh93 projects
                if (fnIsRootPage()) {
                    isRootPage = true;

                    $('#btnHome').addClass('invisible');
                    const homeIcon = '<span style="font-size: 1em;color:blue;"><i class="fa-solid fa-house"></i></span>';
                    const homeIconSpan = $(homeIcon);
                    $('#divLeft').append(homeIconSpan);
                    // Move version display to right after home icon for root page
                    var versionText = $('#versionDisplay').text();
                    if (versionText) {
                        $('#versionDisplay').hide();
                        var versionSpan = $('<span class="version-display" style="margin-left: 10px; font-weight: bold; color: #6c757d;">' + versionText + '</span>');
                        homeIconSpan.after(versionSpan);
                    } else {
                        // If version not loaded yet, create empty span and it will be updated by loadVersion
                        var versionSpan = $('<span class="version-display version-display-after-home" style="margin-left: 10px; font-weight: bold; color: #6c757d;"></span>');
                        homeIconSpan.after(versionSpan);
                        $('#versionDisplay').hide();
                    }
                    $('#mdcontainer').addClass('work-index');
                }

                // Set document title - will be updated later if outline content exists
                document.title = app.src.toLowerCase().replace('../', '').replace('./', '').replace('_loadingdocuments/', '');


                console.log('isRootPage:', isRootPage, ',app.src:', app.src);

                // Without this line, clone was not working.
                await app.render({
                    // The class `line-numbers` will be added to the markdown-body container
                    classes: 'line-numbers',
                    // These are Marked options (moh, 13/12/22, commented to render table correclty.)
                    // gfm: false,
                    // mangle: false
                })

                // Check file exists
                UrlExists(app.src);

                // Uncomment below to see original DOM tags right after zero-md.
                //return;

                //-----------------------------
                // Clone starts from here
                //-----------------------------                

                var mdStyle = app.shadowRoot.childNodes[0];
                var mdBody = app.shadowRoot.childNodes[1];
                console.log('mdBody:', mdBody);

                // Add keyup etc event listener
                const inputSearch = document.getElementById("inputSearch");
                const btnHome = document.getElementById("btnHome");
                const btnReset = document.getElementById("btnReset");
                const btnWrapIt = document.getElementById("btnWrapIt");
                const btnPDF = document.getElementById("btnPDF");
                const btnH1Only = document.getElementById("btnH1Only");
                const btnExit = document.getElementById("btnExit");
                
                // Mobile menu elements
                const btnHamburger = document.getElementById("btnHamburger");
                const mobileMenuOverlay = document.getElementById("mobileMenuOverlay");
                const btnMobileHome = document.getElementById("btnMobileHome");
                const btnMobileReset = document.getElementById("btnMobileReset");
                const btnMobileWrapIt = document.getElementById("btnMobileWrapIt");
                const btnMobilePDF = document.getElementById("btnMobilePDF");
                const btnMobileH1Only = document.getElementById("btnMobileH1Only");
                const btnMobileExit = document.getElementById("btnMobileExit");

                // Show Exit button only for moh93 project
                if (window._isMoh93Project) {
                    btnExit.style.display = 'inline-block';
                    btnMobileExit.style.display = 'block';
                }

                // Hamburger menu toggle function
                function toggleMobileMenu() {
                    mobileMenuOverlay.classList.toggle('show');
                }
                
                function closeMobileMenu() {
                    mobileMenuOverlay.classList.remove('show');
                }
                
                // Close mobile menu when clicking outside
                mobileMenuOverlay.addEventListener('click', function(e) {
                    if (e.target === mobileMenuOverlay) {
                        closeMobileMenu();
                    }
                });

                //-----------------------------
                // Event Handler
                //-----------------------------  
                // On keyup, search!
                inputSearch.addEventListener("keyup", searchText);
                btnHome.addEventListener("click", goHome);
                btnReset.addEventListener("click", resetText);
                btnWrapIt.addEventListener("click", toggleWrap);
                btnPDF.addEventListener("click", convert2PDF);
                btnH1Only.addEventListener("click", toggleH1Only);
                btnExit.addEventListener("click", function() {
                    // Redirect to root URL
                    window.location.href = window.location.protocol + '//' + window.location.host + '/';
                });
                
                // Hamburger menu toggle
                if (btnHamburger) {
                    btnHamburger.addEventListener("click", toggleMobileMenu);
                }
                
                // Wire up mobile menu buttons to same handlers
                if (btnMobileHome) {
                    btnMobileHome.addEventListener("click", function() {
                        closeMobileMenu();
                        goHome();
                    });
                }
                if (btnMobileReset) {
                    btnMobileReset.addEventListener("click", function() {
                        closeMobileMenu();
                        resetText();
                    });
                }
                if (btnMobileWrapIt) {
                    btnMobileWrapIt.addEventListener("click", function() {
                        closeMobileMenu();
                        toggleWrap();
                    });
                }
                if (btnMobilePDF) {
                    btnMobilePDF.addEventListener("click", function() {
                        closeMobileMenu();
                        convert2PDF();
                    });
                }
                if (btnMobileH1Only) {
                    btnMobileH1Only.addEventListener("click", function() {
                        closeMobileMenu();
                        toggleH1Only();
                    });
                }
                if (btnMobileExit) {
                    btnMobileExit.addEventListener("click", function() {
                        closeMobileMenu();
                        window.location.href = window.location.protocol + '//' + window.location.host + '/';
                    });
                }



                //-----------------------------
                // ChangeBody start: move html elements to clone node because you cannot play shadow doms with jQuery
                //-----------------------------
                // debugger;
                // Hide zero-md
                $(app).addClass('invisible');
                mdClone = document.createElement("zero-md-clone");

                //mdClone.append(mdBody);
                var div = changeBody();
                mdClone.append(div);
                document.getElementById("mdcontainer").append(mdClone);
                // Now it shows zero-md-clone

                //---------------
                // Page Load
                //----------------
                // To use bootstrap/github css + apply custom css
                $('table').addClass('table');
                $('div.all').addClass('markdown-body');
                applyCustomCss();

                addImageFolderButton();
                
                // Skip focus on mobile devices to avoid keyboard blocking the screen
                function isMobileDevice() {
                    // Check for touch capability
                    var hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    // Check for small screen width (mobile breakpoint)
                    var isSmallScreen = window.innerWidth <= 768;
                    return hasTouch && isSmallScreen;
                }
                
                if (!isMobileDevice()) {
                    inputSearch.focus();
                }

                // Create table navigation buttons
                createTableNavigation();

                // Initialize Mermaid diagrams
                initializeMermaidDiagrams();

                //-----------------------------
                // ChangeBody done.
                //-----------------------------

                // Button `Wrap with md.htm` clicked already?
                var isWrapped = localStorage.getItem(_isWrapped);
                // For moh93 project, always wrap links to use src parameter format
                if (isWrapped == "1" || window._isMoh93Project) {
                    wrapWithMdHtml();
                    // Ensure localStorage is set for moh93 project
                    if (window._isMoh93Project) {
                        localStorage.setItem(_isWrapped, '1');
                    }
                }

                var strNth = localStorage.getItem(_expandedNth);
                console.log('strNth:', strNth);

                if (strNth != null) {
                    var nthArray = strNth.split(',');
                    nthArray.forEach(expandFunction)

                    // Remember expanded button status in local storage. Keep it expanded when the page is refreshed.
                    function expandFunction(item) {
                        var selector = '.h1-wrapper:nth-child(#n)'.replace('#n', parseInt(item));
                        // console.log('selector:', selector);

                        var btnExpand = $(selector).find('.btn-ex-collapse');
                        if (btnExpand.length) {
                            btnExpand.click();    // dangerous, but it seems I did this for initial expanding.
                        }
                    }

                }

                // Retrieve search text on page load
                // This part should be positioned here at the last. Otherwise, folding/unfolding will show override search result.
                inputSearch.value = localStorage.getItem(_searchText);
                if (isRootPage) {
                    // Apply filter only in root page.
                    searchText();
                }

                // Handle anchor navigation after page is fully loaded
                // Wait a bit for all content to render, then scroll to anchor
                setTimeout(function() {
                    var hash = window.location.hash;
                    if (hash) {
                        // Remove the # from hash
                        var anchorId = hash.substring(1);
                        
                        // Try to find the element by ID
                        var targetElement = document.getElementById(anchorId);
                        
                        if (!targetElement) {
                            // If not found by ID, try to find by text content in headings
                            var headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
                            for (var i = 0; i < headings.length; i++) {
                                var headingText = (headings[i].textContent || headings[i].innerText || '').trim().toLowerCase();
                                var anchorText = anchorId.toLowerCase();
                                // Check if heading text matches anchor (with or without spaces/hyphens)
                                if (headingText === anchorText || 
                                    headingText.replace(/\s+/g, '-') === anchorText ||
                                    headingText.replace(/\s+/g, '') === anchorText.replace(/-/g, '')) {
                                    targetElement = headings[i];
                                    break;
                                }
                            }
                        }
                        
                        if (targetElement) {
                            // Calculate offset for fixed header
                            var searchWrapper = document.querySelector('.search-wrapper');
                            var offset = searchWrapper ? searchWrapper.offsetHeight + 20 : 80;
                            
                            var elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                            var offsetPosition = elementPosition - offset;
                            
                            window.scrollTo({
                                top: offsetPosition,
                                behavior: 'smooth'
                            });
                            
                            // Highlight the element briefly
                            targetElement.style.backgroundColor = '#fff3cd';
                            setTimeout(function() {
                                targetElement.style.backgroundColor = '';
                            }, 2000);
                        }
                    }
                }, 500); // Wait 500ms for content to render

                //-----------------------
                // FUNCTIONS
                //-----------------------

                function addImageFolderButton() {
                    // 1. clone copy button
                    // 2. append it beside image
                    const btnClone = $('#btnImageFolder').clone();

                    btnClone.removeAttr('id');
                    btnClone.addClass('btn-image-folder');
                    btnClone.removeClass('btn-primary invisible').addClass('btn-secondary');
                    btnClone.html(btnClone.html().replace('Copy', ''));
                    // no text just image button

                    document.addEventListener("click", function (e) {
                        const target = e.target.closest(".btn-image-folder"); // Or any other selector.
                        if (target) {
                            // Do something with `target`.
                            copyImageFolderPathToClipboard(target);
                            $(target).after('<span class="copied"> Copied</span>');
                            setTimeout(function () {
                                $('.copied').remove();
                            }, 1000);
                        }
                    });

                    $('p').find('img:last').after(btnClone);
                }

                // Change mdBody structure nested from plain
                // Before: <h1/> <ul/> <h2/> <h1/>
                // After: <h1><ul/><h2></h1> <h1></h1>
                /**
                 * Extract and handle markdown frontmatter metadata from rendered HTML
                 * Metadata appears as h1/h2 elements with key:value patterns (e.g., "documentLevel: public")
                 * @param {jQuery|HTMLElement} mdBody - The markdown body element
                 * @returns {HTMLElement|null} - Metadata container element, or null if no metadata found
                 */
                function extractMetadata(mdBody) {
                    var metadataElements = [];
                    var $mdBody = $(mdBody);
                    
                    // Metadata typically has pattern: "key: value" or multiple keys on one line
                    function looksLikeMetadata(text) {
                        if (!text || text.trim().length === 0) return false;
                        var trimmed = text.trim();
                        var hasColon = trimmed.includes(':');
                        var isShort = trimmed.length < 150; // Metadata is typically short
                        var hasMetadataKeywords = /^(documentLevel|title|author|date|tags|category|description):/i.test(trimmed);
                        return hasColon && (isShort || hasMetadataKeywords);
                    }
                    
                    // Track HR elements that need to be removed (between metadata elements)
                    var hrElementsToRemove = [];
                    
                    // Check ALL h1 and h2 elements to find metadata (metadata should be at the beginning)
                    // Check both h1 and h2 elements for metadata (metadata can be in either)
                    // Metadata is always at the beginning of the document
                    
                    // First, check if the first element is an h1 that looks like metadata
                    var firstH1 = $mdBody.find('h1').first();
                    if (firstH1.length > 0) {
                        var h1Text = firstH1.text().trim();
                        console.log('Checking first h1:', h1Text);
                        if (looksLikeMetadata(h1Text)) {
                            console.log('Found metadata h1:', h1Text);
                            metadataElements.push(firstH1[0]);
                            
                            // Check for h2 that follows (could be separated by hr)
                            var nextSibling = firstH1.next();
                            if (nextSibling.length > 0 && nextSibling[0].tagName === 'HR') {
                                var hrElem = nextSibling[0];
                                var afterHr = nextSibling.next();
                                if (afterHr.length > 0 && afterHr[0].tagName === 'H2') {
                                    var h2Text = afterHr.text().trim();
                                    console.log('Found h2 after hr:', h2Text);
                                    if (looksLikeMetadata(h2Text)) {
                                        metadataElements.push(afterHr[0]);
                                        hrElementsToRemove.push(hrElem);
                                    }
                                }
                            } else if (nextSibling.length > 0 && nextSibling[0].tagName === 'H2') {
                                var h2Text = nextSibling.text().trim();
                                console.log('Found h2 directly after h1:', h2Text);
                                if (looksLikeMetadata(h2Text)) {
                                    metadataElements.push(nextSibling[0]);
                                }
                            }
                        }
                    }
                    
                    // Also check if the first h2 (or early h2) contains metadata
                    // This handles cases where metadata is only in h2, not h1
                    if (metadataElements.length === 0) {
                        var firstH2 = $mdBody.find('h2').first();
                        if (firstH2.length > 0) {
                            var h2Text = firstH2.text().trim();
                            console.log('Checking first h2:', h2Text);
                            if (looksLikeMetadata(h2Text)) {
                                console.log('Found metadata h2:', h2Text);
                                metadataElements.push(firstH2[0]);
                            }
                        }
                    }
                    
                    console.log('Metadata elements found:', metadataElements.length);
                    
                    // If we found metadata elements, create a container and remove them from mdBody
                    if (metadataElements.length === 0) {
                        return null;
                    }
                    
                    var metadataContainer = document.createElement('div');
                    metadataContainer.className = 'markdown-metadata';
                    
                    // Extract metadata text and combine into single line separated by commas
                    var allMetadataParts = [];
                    metadataElements.forEach(function(elem) {
                        var text = elem.textContent.trim();
                        console.log('Removing metadata element:', text);
                        if (text) {
                            // Parse metadata text to extract individual key:value pairs
                            // Handle formats like "key1: value1 key2: value2" or "key1: value1, key2: value2"
                            // Split on spaces that come before a word followed by colon (new key)
                            // This regex looks for: space(s) followed by word(s) followed by colon
                            var parts = text.split(/\s+(?=[a-zA-Z][a-zA-Z0-9]*\s*:)/);
                            
                            // If splitting didn't work (maybe already comma-separated or single item), use the whole text
                            if (parts.length === 1) {
                                // Check if it contains multiple key:value pairs without separators
                                // Try to split on pattern: "word: value" followed by space and another "word:"
                                var keyValuePattern = /([a-zA-Z][a-zA-Z0-9]*\s*:[^:]+?)(?=\s+[a-zA-Z][a-zA-Z0-9]*\s*:|$)/g;
                                var matches = text.match(keyValuePattern);
                                if (matches && matches.length > 1) {
                                    // Found multiple key:value pairs, use them
                                    matches.forEach(function(match) {
                                        var trimmed = match.trim();
                                        if (trimmed) {
                                            allMetadataParts.push(trimmed);
                                        }
                                    });
                                } else {
                                    // Single item or already formatted, use as-is
                                    allMetadataParts.push(text);
                                }
                            } else {
                                // Successfully split into parts
                                parts.forEach(function(part) {
                                    part = part.trim();
                                    if (part) {
                                        allMetadataParts.push(part);
                                    }
                                });
                            }
                        }
                        
                        // Remove from DOM using native method (more reliable than jQuery for shadow DOM)
                        if (elem.parentNode) {
                            elem.parentNode.removeChild(elem);
                        }
                    });
                    
                    // Add S3 key if available
                    if (app && app.src) {
                        var currentDocKey = '';
                        if (typeof getCurrentDocumentKey === 'function') {
                            currentDocKey = getCurrentDocumentKey(app);
                        } else {
                            // Fallback: try to extract key directly
                            try {
                                var keyMatch = app.src.match(/[?&]key=([^&]+)/);
                                if (keyMatch) {
                                    currentDocKey = decodeURIComponent(keyMatch[1]);
                                }
                            } catch (e) {
                                console.log('Could not extract current document key for metadata:', e);
                            }
                        }
                        
                        if (currentDocKey) {
                            allMetadataParts.push('S3 key: ' + currentDocKey);
                        }
                    }
                    
                    // Create a single span with all metadata separated by commas
                    if (allMetadataParts.length > 0) {
                        var span = document.createElement('span');
                        span.className = 'metadata-line';
                        span.textContent = allMetadataParts.join(', ');
                        metadataContainer.appendChild(span);
                    }
                    
                    // Remove hr elements that were between metadata (must be done after removing h1/h2 elements)
                    hrElementsToRemove.forEach(function(hrElem) {
                        if (hrElem.parentNode) {
                            hrElem.parentNode.removeChild(hrElem);
                        }
                    });
                    
                    // Also remove any hr elements near the beginning of the document (they're usually from markdown separators)
                    $mdBody.find('hr').each(function() {
                        var $hr = $(this);
                        // Remove hr elements that are among the first few children
                        var allChildren = $mdBody.children();
                        var hrIndex = allChildren.index(this);
                        if (hrIndex >= 0 && hrIndex < 5) { // Within first 5 elements
                            if (this.parentNode) {
                                this.parentNode.removeChild(this);
                            }
                        }
                    });
                    
                    console.log('Metadata removed. Remaining h1 count:', $mdBody.find('h1').length);
                    
                    return metadataContainer;
                }

                function changeBody() {
                    // Extract metadata FIRST, before any processing that creates h1-wrapper
                    var metadataContainer = extractMetadata(mdBody);
                    
                    // To help search result better, add some css class for h1, h2
                    console.log('length', $(mdBody).find('h1').length);

                    var divAll = document.createElement("div");
                    divAll.classList.add('all');

                    // Add metadata container at the beginning, separate from h1-wrapper elements
                    if (metadataContainer) {
                        divAll.appendChild(metadataContainer);
                    }

                    // `Document start ~ first h1` was not be shown in <zero-md-clone>
                    // Note: Metadata has already been removed from mdBody by extractMetadata(), 
                    // so noTagElems will not contain metadata text
                    var noTagElems = $(mdBody).html().split('<h1')[0];
                    if (noTagElems.length > 0 && !noTagElems.startsWith('<h1')) {
                        //console.log('noTagElems:', noTagElems);

                        // Extract first line to create a title h1
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = noTagElems;
                        var firstLine = tempDiv.textContent.trim().split('\n')[0];

                        var h1Wrapper = document.createElement("div");
                        h1Wrapper.className = 'h1-wrapper';

                        if (firstLine && firstLine.length > 0) {
                            // Create title h1 from first line and remove it from the content
                            var remainingContent = noTagElems.replace(firstLine, '').trim();
                            // Remove empty <li> elements
                            if (remainingContent) {
                                var tempContentDiv = document.createElement('div');
                                tempContentDiv.innerHTML = remainingContent;
                                var lis = tempContentDiv.querySelectorAll('li');
                                lis.forEach(function (li) {
                                    if (!li.textContent.trim()) {
                                        li.remove();
                                    }
                                });
                                remainingContent = tempContentDiv.innerHTML;
                            }
                            h1Wrapper.innerHTML = '<h1>' + firstLine + '</h1>' + (remainingContent ? remainingContent : '');
                        } else {
                            h1Wrapper.innerHTML = '<h1>Outline</h1>' + noTagElems;
                        }
                        if (fnIsRootPage()) {
                            // + '<button class="btn btn-sm btn-danger" onclick="RemoveButtonClicked()">Remove</button>'
                            var btnx = '<button class="close" aria-label="Close" onclick="RemoveHistoryItem()"><span aria-hidden="true">&times;</span></button>';

                            h1Wrapper.innerHTML = '<h1 id="h1Recent">Recently viewed ...'
                                + btnx
                                + '</h1>'
                                + getHistoryArrayHtml();
                        }
                        divAll.append(h1Wrapper);
                    }

                    // The entire document will be restructured by <h1> tag.
                    $(mdBody).find('h1').each(function () {
                        var h1Wrapper = document.createElement("div");
                        h1Wrapper.className = 'h1-wrapper';

                        var clone = this.cloneNode(true);       //add current h1 into div.h1-wrapper
                        h1Wrapper.append(clone);

                        // add all the following elems until next h1 into div.h1-wrapper
                        $(this).nextUntil('h1').each(function () {
                            clone = this.cloneNode(true);
                            h1Wrapper.append(clone);
                        });
                        divAll.append(h1Wrapper);
                    });

                    console.log('all', divAll);
                    return divAll;
                }

                function applyCustomCss() {
                    $('a').each(function () {
                        var txtOrg = $(this).text().toLowerCase();
                        var boldWords = ["loading", "summary", "itwiki", "release"];
                        var orangeWords = ["bau"];

                        // console.log('searchWord:', searchWord);
                        // console.log('txtOrg:', txtOrg);

                        // Note that below style will be overwritten by the last if.
                        boldWords.forEach((elem) => {
                            if (txtOrg.indexOf(elem) >= 0) {
                                // add green css
                                var txtReplaced = txtOrg.replace(elem, `<span class="green">${elem}</span>`);
                                $(this).html(txtReplaced);
                            }
                        });

                        orangeWords.forEach((elem) => {
                            if (txtOrg.indexOf(elem) >= 0) {
                                // add green css
                                var txtReplaced = txtOrg.replace(elem, `<span class="orange">${elem}</span>`);
                                $(this).html(txtReplaced);
                            }
                        });
                    });

                }


                //---------------------
                // On keyup, search    
                //---------------------             
                // Helper function to check if text matches search filter (supports % separator for multiple keywords)
                function matchesSearchFilter(text, filter) {
                    // Split filter by '%' to get multiple keywords
                    var keywords = filter.split('%').map(function(k) { return k.trim(); }).filter(function(k) { return k.length > 0; });
                    
                    if (keywords.length === 0) return false;
                    if (keywords.length === 1) {
                        // Single keyword - simple match
                        return text.indexOf(keywords[0]) >= 0;
                    } else {
                        // Multiple keywords - ALL must be present (AND logic)
                        for (var j = 0; j < keywords.length; j++) {
                            if (text.indexOf(keywords[j]) < 0) {
                                return false;
                            }
                        }
                        return true;
                    }
                }

                function searchText() {

                    var input, filter, ul, tags, a, i, txtValue, elem;
                    filter = inputSearch.value.toUpperCase();

                    // Save search text (otherwise, chrome refreshes it.)
                    localStorage.setItem(_searchText, filter);

                    // 13/1/25 i don't like it anymore because it nullifies loading css etc >> commented
                    //applyHighlightCss();

                    if (filter == "") {
                        // Reset button clicked >> show all content
                        if (fnIsRootPage()) {
                            // Root page: show all h1-wrapper content
                            $('#mdcontainer').find('[style*="display: none"]').slideDown();
                            $('.btn-expand').remove();
                        } else {
                            // Non-root page: show all h1 tags
                            var allH1s = mdClone.querySelectorAll("h1");
                            $(allH1s).show();
                            // Show all content within h1 sections
                            var allContent = mdClone.querySelectorAll("*");
                            $(allContent).show();
                        }
                        return;
                    }

                    // For root page, use the existing complex logic with h1-wrapper
                    if (fnIsRootPage()) {
                        // Todo: make it better to: 
                        // (1) show entire h1 paragraph by adding 'Show all' button to h1, h2, ul 
                        // (2) higlight text
                        tags = mdClone.querySelectorAll("h1,h2,li");

                        // All other tags will be hidden unless filter is reset to "".
                        var otherTags = mdClone.querySelectorAll("table,pre");
                        $(otherTags).hide();

                        console.log('tags length: ', tags.length);
                        for (i = 0; i < tags.length; i++) {
                            elem = tags[i];
                            var elemTagName = elem.tagName;
                            txtValue = elem.textContent || elem.innerText;
                            var searchMatching = matchesSearchFilter(txtValue.toUpperCase(), filter);

                            if (searchMatching) {
                                //$(elem).addClass('highlight');
                                //console.log('txtValue', txtValue);
                                var div = $(elem).closest('.h1-wrapper');

                                // elem is matching with search criteria
                                $(elem).slideDown();
                                if (elemTagName != "H1") {
                                    // h2, li matching
                                    var h1 = div.find('h1');
                                    if (!h1.is(':visible')) {
                                        h1.show();
                                    }
                                }

                                // Ensure tables remain hidden within this h1-wrapper
                                div.find('table,pre').hide();

                                // Show button
                                var btnExpand = div.find('.btn-ex-collapse');


                                //------------------
                                // btnExpand
                                //------------------
                                if (btnExpand.length <= 0) {
                                    // if button does not exist, create one.
                                    console.log('Creating Expand button for h1-wrapper', div);
                                    let btn = document.createElement('button');
                                    btn.innerHTML = "Expand";
                                    btn.classList.add("btn", "btn-sm", "btn-expand", "btn-success", "btn-ex-collapse");  // green expand button
                                    btn.addEventListener("click", function () {

                                        var isExpand = this.innerHTML == 'Expand';
                                        console.log('isExpand', isExpand);
                                        console.log('yo, li');
                                        // find more than one level
                                        // https://stackoverflow.com/questions/7648761/how-to-select-all-children-in-any-level-from-a-parent-in-jquery

                                        // Have to define again here.
                                        var div = $(this).closest('.h1-wrapper');
                                        var children = div.find('*');
                                        console.log('children', children.length);

                                        //https://stackoverflow.com/questions/13550079/how-to-find-nth-element-when-a-click-is-activated
                                        var divs = $('.h1-wrapper');
                                        var divIndex = divs.index(div);

                                        if (isExpand) {
                                            // Expand button clicked - show all content including tables
                                            children.slideDown();
                                            // Explicitly show tables when expanding
                                            div.find('table,pre').show();
                                            btn.innerHTML = 'Collapse';
                                            btn.classList.remove('btn-success');
                                            btn.classList.add('btn-danger');

                                            var strArray = localStorage.getItem(_expandedNth);
                                            var array = [];
                                            if (strArray != null) {
                                                array = strArray.split(',').map(function (item) {
                                                    return parseInt(item, 10);
                                                });
                                            }
                                            console.log('array:', array);
                                            console.log('divIndex:', divIndex);

                                            var nth = divIndex + 1;
                                            if (!array.includes(nth)) {
                                                array.push(nth);
                                                localStorage.setItem(_expandedNth, array.toString());
                                            }

                                        } else {
                                            // Collapse button clicked
                                            searchText();
                                            btn.innerHTML = 'Expand';
                                            btn.classList.add('btn-success');
                                            btn.classList.remove('btn-danger');

                                            localStorage.removeItem(_expandedNth);
                                        }
                                    });
                                    // Ensure h1 element exists before appending button
                                    var h1Element = div.find('h1');
                                    if (h1Element.length > 0) {
                                        h1Element.append(btn);
                                        console.log('Expand button appended to h1 element');
                                    } else {
                                        console.warn('h1 element not found in h1-wrapper, cannot append Expand button. div:', div, 'div HTML:', div.html());
                                    }
                                }

                            } else {
                                // elem doesn't contain search string
                                $(elem).hide();
                            }
                        }
                        
                        // Ensure all tables remain hidden after filtering
                        var allTables = mdClone.querySelectorAll("table,pre");
                        $(allTables).hide();
                    } else {
                        // Non-root page: filter h1 tags only
                        tags = mdClone.querySelectorAll("h1");
                        console.log('h1 tags length: ', tags.length);
                        
                        for (i = 0; i < tags.length; i++) {
                            elem = tags[i];
                            txtValue = elem.textContent || elem.innerText;
                            var searchMatching = matchesSearchFilter(txtValue.toUpperCase(), filter);

                            if (searchMatching) {
                                // Show this h1 and its content
                                $(elem).show();
                                // Show all following siblings until next h1
                                var nextSibling = elem.nextElementSibling;
                                while (nextSibling && nextSibling.tagName !== 'H1') {
                                    $(nextSibling).show();
                                    nextSibling = nextSibling.nextElementSibling;
                                }
                            } else {
                                // Hide this h1 and its content
                                $(elem).hide();
                                // Hide all following siblings until next h1
                                var nextSibling = elem.nextElementSibling;
                                while (nextSibling && nextSibling.tagName !== 'H1') {
                                    $(nextSibling).hide();
                                    nextSibling = nextSibling.nextElementSibling;
                                }
                            }
                        }
                    }
                }

                function applyHighlightCss() {
                    // var searchWord = $('#inputSearch').val().toLowerCase();   //was empty. didn't work
                    var searchWord = localStorage.getItem(_searchText).toLowerCase();
                    console.log('searchWord:', searchWord);

                    if (searchWord == "") {
                        $('a').each(function () {
                            var ctrl = $(this);
                            console.log('html1:', ctrl.html());
                            // remove span
                            if (ctrl.find('.highlight').length > 0) {
                                removeHighlightCss(ctrl);
                            }
                        });
                        applyCustomCss();
                    }
                    else {
                        $('a').each(function () {
                            var txtOrg = $(this).text().toLowerCase();
                            var ctrl = $(this);

                            if (txtOrg.indexOf(searchWord) >= 0) {
                                // console.log('txtOrg:', txtOrg);
                                var txtReplaced = txtOrg.replace(searchWord, `<span class="highlight">${searchWord}</span>`);
                                ctrl.html(txtReplaced);
                            } else {
                                removeHighlightCss(ctrl);
                            }

                        });
                    }
                }

                function removeHighlightCss(ctrl) {
                    // var txtReplaced = ctrl.html().replace(`<span class="highlight">${searchWord}</span>`, searchWord);
                    // above didn't work with fast typing search.

                    var spanRawText = ctrl.find('.highlight').text();
                    ctrl.find('.highlight').replaceWith(spanRawText);
                }

                // Copied from searchText()
                function showH1Only() {

                    var input, filter, ul, tags, a, i, txtValue, elem;
                    tags = mdClone.querySelectorAll("h1");

                    // All other tags will be hidden unless filter is reset to "". 24/10/24, img added.
                    var otherTags = mdClone.querySelectorAll("table,pre,h2,li,img");
                    $(otherTags).hide();

                    console.log('tags length: ', tags.length);
                    for (i = 0; i < tags.length; i++) {
                        elem = tags[i];
                        var elemTagName = elem.tagName;
                        txtValue = elem.textContent || elem.innerText;

                        var div = $(elem).closest('.h1-wrapper');

                        // elem is matching with search criteria
                        $(elem).slideDown();
                        if (elemTagName != "H1") {
                            // h2, li matching
                            var h1 = div.find('h1');
                            if (!h1.is(':visible')) {
                                h1.show();
                            }
                        }

                        // Show button
                        var btnExpand = div.find('.btn-ex-collapse');

                        //------------------
                        // btnExpand
                        //------------------
                        if (btnExpand.length <= 0) {
                            // if button does not exist, create one.
                            let btn = document.createElement('button');
                            btn.innerHTML = "Expand";
                            btn.classList.add("btn", "btn-sm", "btn-expand", "btn-success", "btn-ex-collapse");  // green expand button
                            btn.addEventListener("click", function () {

                                var isExpand = this.innerHTML == 'Expand';
                                console.log('isExpand', isExpand);
                                console.log('yo, li');
                                // find more than one level
                                // https://stackoverflow.com/questions/7648761/how-to-select-all-children-in-any-level-from-a-parent-in-jquery

                                // Have to define again here.
                                var div = $(this).closest('.h1-wrapper');
                                var children = div.find('*');
                                console.log('children', children.length);

                                //https://stackoverflow.com/questions/13550079/how-to-find-nth-element-when-a-click-is-activated
                                var divs = $('.h1-wrapper');
                                var divIndex = divs.index(div);

                                if (isExpand) {
                                    // Expand button clicked
                                    children.slideDown();
                                    btn.innerHTML = 'Collapse';
                                    btn.classList.remove('btn-success');
                                    btn.classList.add('btn-danger');

                                } else {
                                    // Collapse button clicked
                                    searchText();
                                    btn.innerHTML = 'Expand';
                                    btn.classList.add('btn-success');
                                    btn.classList.remove('btn-danger');
                                }
                            });
                            div.find('h1').append(btn);
                        }


                    }
                }


                function resetText() {
                    inputSearch.value = "";
                    searchText();
                }

                function goHome() {
                    // Reset search box when you come back from subpage to homepage
                    // localStorage.removeItem(_searchText);
                    // inputSearch.value = localStorage.getItem(_searchText);

                    if (window._isMoh93Project) {
                        // For moh93 project, navigate to LoadingDocs page
                        location.href = window.location.protocol + '//' + window.location.host + '/LoadingDocs';
                    } else {
                        // For other projects, use the original localhost path
                        location.href = 'http://127.0.0.1:' + window.location.port + '/md/md.htm';
                    }
                }

                //moh, 13/3/25, no one seems to call this.
                //https://webdeveloper.com/community/60349-is-there-a-way-to-simulate-ctrl-a-ctrl-c-in-javascript/
                function copyToClipboard() {
                    document.execCommand("SelectAll", true);
                    document.execCommand("Copy", true);
                    alert('Copied');
                }

                function copyImageFolderPathToClipboard(btnClicked) {
                    var folder = 'C:\\Works\\';
                    var imgLast = $(btnClicked).closest('p').find('img:last');
                    var imgPath = imgLast.attr('src').replace('http://', '').replace('https://', '');
                    var words = imgPath.split('/');
                    words.shift();
                    words.pop();

                    var resFolderPath = folder + words.toString().replaceAll(',', '\\').replaceAll('.\\', '').replaceAll('%20', ' ');
                    console.log('resFolderPath', resFolderPath);
                    navigator.clipboard.writeText(resFolderPath);
                }

                function insertAfter(referenceNode, newNode) {
                    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
                }

                function toggleWrap() {
                    var isWrapped = localStorage.getItem(_isWrapped);
                    if (isWrapped != '1') {
                        wrapWithMdHtml();
                        localStorage.setItem(_isWrapped, '1');
                    } else {
                        unWrapWithMdHtml();
                        localStorage.setItem(_isWrapped, '0');
                    }
                }

                function toggleH1Only() {
                    if (btnH1Only.getHTML() == "Show H1 Only") {
                        btnH1Only.innerHTML = 'Show ALL';
                        $('h1').addClass('font-size-normal');
                        showH1Only();
                    } else {
                        location.reload();
                    }
                }

                //https://stackoverflow.com/questions/43333286/uncaught-referenceerror-jspdf-is-not-defined
                //https://github.com/parallax/jsPDF?tab=readme-ov-file
                //https://phppot.com/javascript/html-to-pdf-in-javascript-using-jspdf/
                function convert2PDF() {
                    $('#btnPDF').html('...');
                    doc_PlainFormat();

                    const { jsPDF } = window.jspdf;
                    var doc = new jsPDF('l', 'mm', [1200, 1210]);
                    var pdfjs = document.querySelector('.markdown-body');
                    var filename = _url.split('/').pop().toLowerCase().replace('.md', '.pdf');

                    // Convert HTML to PDF in JavaScript
                    doc.html(pdfjs, {
                        callback: function (doc) {
                            doc.save(filename);
                            doc_StyleFormat();
                            $('#btnPDF').html('PDF');
                        },
                        x: 10,
                        y: 10
                    });
                }

                function doc_PlainFormat() {
                    var isWrapped = localStorage.getItem(_isWrapped);
                    if (isWrapped == '1') {
                        unWrapWithMdHtml();
                        localStorage.setItem(_isWrapped, '0');
                    }
                }

                function doc_StyleFormat() {
                    var isWrapped = localStorage.getItem(_isWrapped);
                    if (isWrapped != '1') {
                        wrapWithMdHtml();
                        localStorage.setItem(_isWrapped, '1');
                    }
                }


                // Convert a markdown file URL to md.htm?src= format for non-moh93 projects
                // Returns the converted URL string, or null if the URL should be skipped (external or already wrapped)
                function createMdHtmUrl(urlWithoutAnchor) {
                    var baseUrl = window.location.protocol + '//' + window.location.host;
                    var mdBasePath = baseUrl + '/md/md.htm?src=';
                    
                    // Check if it's already a full URL (starts with http:// or https://)
                    if (urlWithoutAnchor.startsWith('http://') || urlWithoutAnchor.startsWith('https://')) {
                        // Full URL - check if it's localhost
                        if (urlWithoutAnchor.includes('127.0.0.1') || urlWithoutAnchor.includes('localhost')) {
                            // Extract the path from the URL
                            try {
                                var urlObj = new URL(urlWithoutAnchor);
                                var path = urlObj.pathname;
                                // Remove leading slash
                                if (path.startsWith('/')) {
                                    path = path.substring(1);
                                }
                                // Remove md/ prefix if present (already wrapped)
                                if (path.startsWith('md/md.htm')) {
                                    // Already wrapped, skip
                                    return null;
                                }
                                // Convert to md.htm?src= format
                                return mdBasePath + encodeURIComponent(path);
                            } catch (e) {
                                // URL parsing failed, try string replacement
                                if (urlWithoutAnchor.includes('127.0.0.1:' + window.location.port)) {
                                    // Extract path after host:port
                                    var pathMatch = urlWithoutAnchor.match(/127\.0\.0\.1:\d+\/(.+)/);
                                    if (pathMatch && pathMatch[1]) {
                                        var path = pathMatch[1];
                                        // Remove md/ prefix if present
                                        if (path.startsWith('md/md.htm')) {
                                            return null;
                                        }
                                        return mdBasePath + encodeURIComponent(path);
                                    }
                                }
                            }
                        } else {
                            // External URL, skip wrapping
                            return null;
                        }
                    } else {
                        // Relative path (starts with ./ or ../ or just a filename/path)
                        // Convert relative path to md.htm?src= format
                        return mdBasePath + encodeURIComponent(urlWithoutAnchor);
                    }
                    
                    return null;
                }

                // When button `Wrap with md.htm` is clicked, you do some css changes+DOM changes
                function wrapWithMdHtml() {
                    // Extract current document's key from app.src (function is defined in moh93-custom.js)
                    var currentDocKey = '';
                    if (window._isMoh93Project && app && app.src) {
                        currentDocKey = getCurrentDocumentKey(app);
                        // Debug logging
                        if (currentDocKey) {
                            var baseDir = '';
                            var lastSlashIndex = currentDocKey.lastIndexOf('/');
                            if (lastSlashIndex >= 0) {
                                baseDir = currentDocKey.substring(0, lastSlashIndex + 1);
                            }
                            if (baseDir) {
                                console.log('Current document base directory:', baseDir, 'from key:', currentDocKey);
                            }
                        }
                    }
                    
                    // wrap xxx.md file line
                    $('a').each(function () {
                        var oldUrl = $(this).attr("href");
                        if (oldUrl != undefined) {
                            // Check if URL contains .md (not just ends with it, to handle anchors like .md#anchor)
                            if (oldUrl.includes(".md")) {
                                // Extract anchor if present (e.g., #supplementary)
                                var anchorPart = '';
                                var anchorIndex = oldUrl.indexOf('#');
                                var urlWithoutAnchor = oldUrl;
                                if (anchorIndex > 0) {
                                    anchorPart = oldUrl.substring(anchorIndex);
                                    urlWithoutAnchor = oldUrl.substring(0, anchorIndex);
                                }
                                
                                var newUrl = '';
                                
                                if (window._isMoh93Project) {
                                    // For moh93 project: convert to md-project/md.htm?src=https://home.moh93.com/LoadingDocs?handler=Markdown&key=...
                                    var baseUrl = window.location.protocol + '//' + window.location.host;
                                    var mdPath = '';
                                    //console.log('old url:', oldUrl);
    
                                    // resolveRelativePath function is defined in moh93-custom.js
                                    
                                    if (urlWithoutAnchor.startsWith('http://') || urlWithoutAnchor.startsWith('https://')) {
                                        // Full URL - extract the path
                                        try {
                                            var urlObj = new URL(urlWithoutAnchor);
                                            
                                            // If the URL points to LoadingDocs with a key parameter, extract and use that key directly
                                            if (urlObj.searchParams.has('key')) {
                                                mdPath = urlObj.searchParams.get('key');
                                            } else {
                                                // Extract pathname
                                                mdPath = urlObj.pathname;
                                                // Remove leading slash if present
                                                if (mdPath.startsWith('/')) {
                                                    mdPath = mdPath.substring(1);
                                                }
                                                // Remove md-project/ or md/ prefix if present (these are just web paths, not S3 keys)
                                                mdPath = mdPath.replace(/^md-project\//, '').replace(/^md\//, '');
                                                
                                                // Handle relative indicators (./ or ../) in the path
                                                mdPath = resolveRelativePath(mdPath, currentDocKey);
                                                
                                                // If path doesn't start with _LoadingDocuments and has slashes, it might be a web path
                                                // Extract just the filename and re-apply base directory logic
                                                if (!mdPath.startsWith('_LoadingDocuments') && mdPath.indexOf('/') >= 0) {
                                                    var lastSlashIndex = mdPath.lastIndexOf('/');
                                                    var filename = mdPath.substring(lastSlashIndex + 1);
                                                    // Check if the part before filename is a valid directory (not just web path)
                                                    var pathBeforeFile = mdPath.substring(0, lastSlashIndex);
                                                    if (pathBeforeFile === 'LoadingDocuments' || pathBeforeFile.startsWith('_LoadingDocuments')) {
                                                        // This is an S3 key path, use as-is
                                                        mdPath = mdPath;
                                                    } else {
                                                        // This is a web path, extract filename and apply base directory
                                                        mdPath = resolveRelativePath(filename, currentDocKey);
                                                    }
                                                }
                                            }
                                        } catch (e) {
                                            // If URL parsing fails, extract path and resolve relative indicators
                                            mdPath = urlWithoutAnchor.replace(/^https?:\/\/[^\/]+/, '').replace(/^\//, '').replace(/^md-project\//, '').replace(/^md\//, '');
                                            mdPath = resolveRelativePath(mdPath, currentDocKey);
                                            // Extract filename if path still has web path components
                                            var lastSlashIndex = mdPath.lastIndexOf('/');
                                            if (lastSlashIndex >= 0 && !mdPath.startsWith('_LoadingDocuments')) {
                                                var filename = mdPath.substring(lastSlashIndex + 1);
                                                mdPath = resolveRelativePath(filename, currentDocKey);
                                            }
                                        }
                                    } else {
                                        // Relative path (not http:// or https://) - resolve relative indicators
                                        mdPath = resolveRelativePath(urlWithoutAnchor, currentDocKey);
                                    }
                                    
                                    // Construct the LoadingDocs URL
                                    var loadingDocsUrl = baseUrl + '/LoadingDocs?handler=Markdown&key=' + encodeURIComponent(mdPath);
                                    newUrl = baseUrl + '/md-project/md.htm?src=' + encodeURIComponent(loadingDocsUrl);
                                } else {
                                    // For non-moh93 projects: original localhost logic with 127.0.0.1
                                    newUrl = createMdHtmUrl(urlWithoutAnchor);
                                    if (newUrl === null) {
                                        // Should skip wrapping (external URL or already wrapped)
                                        return;
                                    }
                                    
                                    // If newUrl is still empty, fall back to old logic for backward compatibility
                                    if (!newUrl) {
                                        if (oldUrl.includes('127.0.0.1')) {
                                            // href to md files
                                            newUrl = urlWithoutAnchor.replace("127.0.0.1:" + window.location.port + "/./", "127.0.0.1:" + window.location.port + "/md/md.htm?src=../");
                                            newUrl = newUrl.replace("127.0.0.1:" + window.location.port + "/_LoadingDocuments/", "127.0.0.1:" + window.location.port + "/md/md.htm?src=../_LoadingDocuments/");
                                        } else {
                                            // Not a localhost URL, skip wrapping
                                            return;
                                        }
                                    }
                                }
                                
                                // Append anchor back if it existed
                                if (anchorPart) {
                                    newUrl = newUrl + anchorPart;
                                }
                                
                                $(this).attr("href", newUrl);
                                
                                // If link source starts with "cursor" and ends with ".md", open in new tab
                                // Check the original URL path (extract filename from URL)
                                var urlPath = urlWithoutAnchor.toLowerCase();
                                var fileName = urlPath.split('/').pop().split('#')[0]; // Get filename without anchor
                                if (fileName.startsWith('cursor') && fileName.endsWith('.md')) {
                                    $(this).attr('target', '_blank');
                                }
                                // Otherwise, open in current page (no target attribute)
                            } 
                            else if (oldUrl.startsWith("#")) {
                                //markdown anchor -> do not change target
                            }
                            else {
                                // all other general href
                                $(this).attr('target', '_blank');
                            }
                        }                        
                    });

                    // get image width and height from source
                    const getMeta = (url, cb) => {
                        const img = new Image();
                        img.onload = () => cb(null, img);
                        img.onerror = (err) => cb(err);
                        img.src = url;
                    };

                    // Function to wrap images with photoswipe links
                    function wrapImagesWithPhotoswipe() {
                        // wrap each img tag with hyperlink
                        $('img').not('.photoswipe img').addClass('sm');

                        var Photos = "";
                        $('img.sm').each(function () {
                            var $img = $(this);
                            getMeta($img.attr('src'), (err, img) => {
                                if (img != undefined) {
                                    // console.log('img width/height:', img.naturalWidth, img.naturalHeight);

                                    if (img.naturalWidth < 200) {
                                        // really small img >> keep original width
                                        $img.removeClass('sm');
                                    }

                                    var newLink = $("<a />", {
                                        href: $img.attr('src')
                                    });
                                    newLink.attr('data-pswp-width', img.naturalWidth);
                                    newLink.attr('data-pswp-height', img.naturalHeight);
                                    newLink.addClass('photoswipe');
                                    
                                    // Prevent default navigation and manually trigger PhotoSwipe
                                    newLink.on('click', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        
                                        if (window.photoSwipeLightbox) {
                                            // Get all photoswipe links in the gallery
                                            var allLinks = document.querySelectorAll('#mdcontainer a.photoswipe');
                                            var clickedIndex = -1;
                                            for (var j = 0; j < allLinks.length; j++) {
                                                if (allLinks[j] === this) {
                                                    clickedIndex = j;
                                                    break;
                                                }
                                            }
                                            
                                            if (clickedIndex >= 0) {
                                                // Create data source from the gallery
                                                var dataSource = {
                                                    gallery: document.querySelector('#mdcontainer')
                                                };
                                                
                                                // Get initial point for animation
                                                var initialPoint = {
                                                    x: e.clientX || 0,
                                                    y: e.clientY || 0
                                                };
                                                
                                                // Load and open PhotoSwipe
                                                window.photoSwipeLightbox.loadAndOpen(clickedIndex, dataSource, initialPoint);
                                            }
                                        }
                                        
                                        return false;
                                    });

                                    newLink.append($img.clone());
                                    $img.replaceWith(newLink);
                                }
                            });
                        });
                    }

                    // For moh93 project: convert image src attributes to use LoadingDocs handler
                    if (window._isMoh93Project) {
                        var imagePromises = [];
                        $('img').each(function() {
                            var $img = $(this);
                            var imgSrc = $img.attr('src');
                            // Skip if already using LoadingDocs, data URI, or already a presigned S3 URL
                            if (imgSrc && !imgSrc.includes('LoadingDocs') && !imgSrc.startsWith('data:') && !imgSrc.includes('.s3.amazonaws.com')) {
                                var baseUrl = window.location.protocol + '//' + window.location.host;
                                var imgPath = '';
                                
                                if (imgSrc.startsWith('http://') || imgSrc.startsWith('https://')) {
                                    // Full URL - extract the path
                                    try {
                                        var urlObj = new URL(imgSrc);
                                        imgPath = urlObj.pathname;
                                        // Remove leading slash if present
                                        if (imgPath.startsWith('/')) {
                                            imgPath = imgPath.substring(1);
                                        }
                                        // Remove leading ./ if present
                                        imgPath = imgPath.replace(/^\.\//, '');
                                    } catch (e) {
                                        // If URL parsing fails, use the original path
                                        imgPath = imgSrc.replace(/^https?:\/\/[^\/]+/, '').replace(/^\//, '').replace(/^\.\//, '');
                                    }
                                } else {
                                    // Relative path - use as is
                                    imgPath = imgSrc;
                                    // Remove leading ./ or ../
                                    imgPath = imgPath.replace(/^\.\//, '').replace(/^\.\.\//, '');
                                }
                                
                                // Ensure image path includes _LoadingDocuments prefix if not already present
                                if (!imgPath.startsWith('_LoadingDocuments/')) {
                                    imgPath = '_LoadingDocuments/' + imgPath;
                                }
                                
                                // Fetch the presigned URL from LoadingDocs handler
                                var loadingDocsUrl = baseUrl + '/LoadingDocs?handler=Image&key=' + encodeURIComponent(imgPath);
                                var promise = $.ajax({
                                    url: loadingDocsUrl,
                                    method: 'GET'
                                }).then(function(presignedUrl) {
                                    // Set the presigned URL as the image src
                                    $img.attr('src', presignedUrl);
                                }).catch(function(xhr, status, error) {
                                    console.error('Failed to get presigned URL for image:', imgPath, error);
                                });
                                imagePromises.push(promise);
                            }
                        });
                        
                        // Wait for all image URLs to be fetched before wrapping with photoswipe
                        Promise.all(imagePromises).then(function() {
                            wrapImagesWithPhotoswipe();
                            // Initialize PhotoSwipe after images are wrapped (only once)
                            setTimeout(function() {
                                if (window.photoSwipeLightbox && !window.photoSwipeLightbox._initialized) {
                                    window.photoSwipeLightbox.init();
                                    window.photoSwipeLightbox._initialized = true;
                                }
                            }, 100);
                        });
                    } else {
                        // For non-moh93 projects, wrap images immediately
                        wrapImagesWithPhotoswipe();
                        // Initialize PhotoSwipe after images are wrapped (only once)
                        setTimeout(function() {
                            if (window.photoSwipeLightbox && !window.photoSwipeLightbox._initialized) {
                                window.photoSwipeLightbox.init();
                                window.photoSwipeLightbox._initialized = true;
                            }
                        }, 100);
                    }


                    // img click event > replaced by photoswipe
                    // $(document).on('click', 'img.sm', function () {
                    //     window.open(this.src, '_blank');
                    // });

                    btnWrapIt.textContent = "Unwrap links"
                    btnWrapIt.classList.add('btn-warning');
                    btnWrapIt.classList.remove('btn-primary');
                }


                function unWrapWithMdHtml() {
                    $('a').each(function () {
                        var oldUrl = $(this).attr("href");
                        if (oldUrl != undefined) {
                            var newUrl = oldUrl.replace("/md/md.htm?src=..", "");
                            $(this).attr("href", newUrl);
                            $(this).attr("target", "_blank");   //open in new tab, 2/11/23
                        }
                    });

                    $('img').removeClass('sm');

                    btnWrapIt.textContent = "Wrap with md.html"
                    btnWrapIt.classList.remove('btn-warning');
                    btnWrapIt.classList.add('btn-primary');
                }

                function initializeMermaidDiagrams() {
                    // Wait for Mermaid library to be available
                    if (typeof mermaid === 'undefined') {
                        setTimeout(initializeMermaidDiagrams, 100);
                        return;
                    }

                    // Initialize Mermaid
                    mermaid.initialize({ startOnLoad: false, theme: 'default' });

                    // Find all Mermaid code blocks
                    var mermaidCodeBlocks = mdClone.querySelectorAll('pre.language-mermaid');
                    
                    mermaidCodeBlocks.forEach(function(preElement) {
                        // Skip if already processed
                        if (preElement.closest('.mermaid-wrapper')) {
                            return;
                        }

                        var mermaidCode = preElement.textContent || preElement.innerText;
                        
                        // Create wrapper div
                        var wrapper = document.createElement('div');
                        wrapper.className = 'mermaid-wrapper';

                        // Create buttons container
                        var buttonsContainer = document.createElement('div');
                        buttonsContainer.className = 'mermaid-buttons';

                        // Create preview/code toggle button
                        var toggleBtn = document.createElement('button');
                        toggleBtn.type = 'button';
                        toggleBtn.className = 'btn btn-primary btn-sm mermaid-toggle-btn';
                        toggleBtn.textContent = 'code';
                        toggleBtn.dataset.showing = 'preview'; // Initially showing preview

                        // Create minimize button
                        var minimizeBtn = document.createElement('button');
                        minimizeBtn.type = 'button';
                        minimizeBtn.className = 'btn btn-secondary btn-sm mermaid-minimize-btn';
                        minimizeBtn.textContent = 'minimize';

                        // Create PNG download button
                        var pngBtn = document.createElement('button');
                        pngBtn.type = 'button';
                        pngBtn.className = 'btn btn-success btn-sm mermaid-png-btn';
                        pngBtn.textContent = 'png';
                        pngBtn.style.display = ''; // Show initially since preview is shown

                        buttonsContainer.appendChild(toggleBtn);
                        buttonsContainer.appendChild(pngBtn);
                        buttonsContainer.appendChild(minimizeBtn);

                        // Create code container
                        var codeContainer = document.createElement('div');
                        codeContainer.className = 'mermaid-code-container';
                        codeContainer.style.display = 'none'; // Hide initially
                        codeContainer.appendChild(preElement.cloneNode(true));

                        // Create preview container
                        var previewContainer = document.createElement('div');
                        previewContainer.className = 'mermaid-preview-container';
                        var previewId = 'mermaid-preview-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        
                        // Create a temporary div with class "mermaid" for rendering
                        var mermaidDiv = document.createElement('div');
                        mermaidDiv.className = 'mermaid';
                        mermaidDiv.id = previewId;
                        mermaidDiv.textContent = mermaidCode.trim();
                        // Hide visually but allow Mermaid to render (use visibility instead of display)
                        mermaidDiv.style.visibility = 'hidden';
                        mermaidDiv.style.position = 'absolute';
                        mermaidDiv.style.left = '-9999px';
                        
                        previewContainer.appendChild(mermaidDiv);

                        // Assemble wrapper
                        wrapper.appendChild(buttonsContainer);
                        wrapper.appendChild(previewContainer);
                        wrapper.appendChild(codeContainer);

                        // Replace original pre element with wrapper
                        preElement.parentNode.replaceChild(wrapper, preElement);

                        // Render Mermaid diagram - wait for DOM to be ready
                        setTimeout(function() {
                            if (typeof mermaid.run === 'function') {
                                // Mermaid v10+ uses mermaid.run()
                                mermaid.run({
                                    nodes: [mermaidDiv]
                                }).then(function() {
                                    var svgElement = mermaidDiv.querySelector('svg');
                                    if (svgElement) {
                                        var svgClone = svgElement.cloneNode(true);
                                        // Remove mermaid div after extracting SVG
                                        previewContainer.innerHTML = '';
                                        previewContainer.appendChild(svgClone);
                                        previewContainer.dataset.svgContent = new XMLSerializer().serializeToString(svgClone);
                                    } else {
                                        // If no SVG, show error
                                        previewContainer.innerHTML = '<p style="color: red;">Error: Diagram did not render</p>';
                                    }
                                }).catch(function(error) {
                                    console.error('Mermaid run error:', error);
                                    renderWithInit();
                                });
                            } else if (typeof mermaid.mermaidAPI !== 'undefined' && typeof mermaid.mermaidAPI.render === 'function') {
                                // Mermaid v8-9 uses mermaid.mermaidAPI.render()
                                mermaid.mermaidAPI.render(previewId, mermaidCode).then(function(result) {
                                    // Remove mermaid div after rendering
                                    previewContainer.innerHTML = result.svg;
                                    previewContainer.dataset.svgContent = result.svg;
                                }).catch(function(err) {
                                    console.error('Mermaid API render error:', err);
                                    renderWithInit();
                                });
                            } else {
                                // Fallback: use mermaid.init() for older versions
                                renderWithInit();
                            }
                            
                            function renderWithInit() {
                                // Use mermaid.init() - works with most versions
                                try {
                                    mermaid.init(undefined, mermaidDiv);
                                    
                                    // Check periodically for rendered SVG
                                    var attempts = 0;
                                    var maxAttempts = 50; // 5 seconds max
                                    var checkInterval = setInterval(function() {
                                        attempts++;
                                        var svgElement = mermaidDiv.querySelector('svg');
                                        if (svgElement) {
                                            clearInterval(checkInterval);
                                            // Remove mermaid div after extracting SVG
                                            var svgClone = svgElement.cloneNode(true);
                                            previewContainer.innerHTML = '';
                                            previewContainer.appendChild(svgClone);
                                            previewContainer.dataset.svgContent = new XMLSerializer().serializeToString(svgClone);
                                        } else if (attempts >= maxAttempts) {
                                            clearInterval(checkInterval);
                                            previewContainer.innerHTML = '<p style="color: red;">Error: Diagram did not render (timeout). Check console for errors.</p>';
                                        }
                                    }, 100);
                                } catch (e) {
                                    console.error('Mermaid init error:', e);
                                    previewContainer.innerHTML = '<p style="color: red;">Error rendering diagram: ' + e.message + '</p>';
                                }
                            }
                        }, 100);

                        // Toggle button click handler
                        toggleBtn.addEventListener('click', function() {
                            var showing = this.dataset.showing;
                            
                            if (showing === 'preview') {
                                // Switch to code view
                                previewContainer.style.display = 'none';
                                codeContainer.style.display = 'block';
                                this.textContent = 'preview';
                                this.dataset.showing = 'code';
                                pngBtn.style.display = 'none'; // Hide PNG button when showing code
                            } else {
                                // Switch to preview view
                                codeContainer.style.display = 'none';
                                previewContainer.style.display = 'block';
                                this.textContent = 'code';
                                this.dataset.showing = 'preview';
                                pngBtn.style.display = ''; // Show PNG button when showing preview
                            }
                        });

                        // Minimize button click handler
                        minimizeBtn.addEventListener('click', function() {
                            var isMinimized = this.textContent === 'show';
                            
                            if (isMinimized) {
                                // Show both containers
                                previewContainer.style.display = '';
                                codeContainer.style.display = '';
                                // Restore the view based on toggle state
                                var showing = toggleBtn.dataset.showing;
                                if (showing === 'preview') {
                                    previewContainer.style.display = 'block';
                                    codeContainer.style.display = 'none';
                                } else {
                                    previewContainer.style.display = 'none';
                                    codeContainer.style.display = 'block';
                                }
                                this.textContent = 'minimize';
                            } else {
                                // Hide both containers
                                previewContainer.style.display = 'none';
                                codeContainer.style.display = 'none';
                                this.textContent = 'show';
                            }
                        });

                        // PNG download button click handler
                        pngBtn.addEventListener('click', function() {
                            var svgElement = previewContainer.querySelector('svg');
                            if (!svgElement) {
                                showToast('No diagram to download', 'error');
                                return;
                            }

                            // Use html2canvas which is already loaded and handles SVG properly
                            if (typeof html2canvas !== 'undefined') {
                                html2canvas(previewContainer, {
                                    backgroundColor: null,
                                    useCORS: true,
                                    logging: false,
                                    width: previewContainer.scrollWidth,
                                    height: previewContainer.scrollHeight
                                }).then(function(canvas) {
                                    // Convert canvas to blob and download
                                    canvas.toBlob(function(blob) {
                                        if (!blob) {
                                            showToast('Error creating PNG', 'error');
                                            return;
                                        }
                                        var downloadUrl = URL.createObjectURL(blob);
                                        var link = document.createElement('a');
                                        link.href = downloadUrl;
                                        link.download = 'mermaid-diagram-' + previewId + '.png';
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                        URL.revokeObjectURL(downloadUrl);
                                        showToast('Diagram downloaded as PNG');
                                    }, 'image/png');
                                }).catch(function(error) {
                                    console.error('html2canvas error:', error);
                                    // Fallback to SVG data URL method
                                    downloadSvgAsPngFallback();
                                });
                            } else {
                                // Fallback method if html2canvas is not available
                                downloadSvgAsPngFallback();
                            }

                            function downloadSvgAsPngFallback() {
                                try {
                                    var svgClone = svgElement.cloneNode(true);
                                    
                                    // Get SVG dimensions
                                    var svgRect = svgElement.getBoundingClientRect();
                                    var svgWidth = svgRect.width || parseInt(svgClone.getAttribute('width')) || 1200;
                                    var svgHeight = svgRect.height || parseInt(svgClone.getAttribute('height')) || 800;

                                    // Ensure SVG has explicit width and height
                                    svgClone.setAttribute('width', svgWidth);
                                    svgClone.setAttribute('height', svgHeight);
                                    svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');

                                    // Serialize SVG and encode as data URL
                                    var svgContent = new XMLSerializer().serializeToString(svgClone);
                                    var svgDataUrl = 'data:image/svg+xml;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(svgContent)));

                                    // Create canvas and load SVG as data URL
                                    var canvas = document.createElement('canvas');
                                    var ctx = canvas.getContext('2d');
                                    var img = new Image();

                                    img.onload = function() {
                                        // Set canvas size
                                        canvas.width = svgWidth;
                                        canvas.height = svgHeight;

                                        // Draw image on canvas
                                        ctx.drawImage(img, 0, 0);

                                        // Convert canvas to blob and download
                                        canvas.toBlob(function(blob) {
                                            if (!blob) {
                                                showToast('Error creating PNG', 'error');
                                                return;
                                            }
                                            var downloadUrl = URL.createObjectURL(blob);
                                            var link = document.createElement('a');
                                            link.href = downloadUrl;
                                            link.download = 'mermaid-diagram-' + previewId + '.png';
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                            URL.revokeObjectURL(downloadUrl);
                                            showToast('Diagram downloaded as PNG');
                                        }, 'image/png');
                                    };

                                    img.onerror = function() {
                                        showToast('Error converting diagram to PNG', 'error');
                                    };

                                    // Load SVG as data URL (this avoids tainting issues)
                                    img.src = svgDataUrl;
                                } catch (error) {
                                    console.error('PNG download error:', error);
                                    showToast('Error downloading diagram: ' + error.message, 'error');
                                }
                            }
                        });
                    });
                }

                function fnIsRootPage() {
                    var isRootPage = false;
                    var srcLower = app.src.toLowerCase();
                    var indexFileLower = _indexMdFile.toLowerCase();
                    
                    // For moh93 project, app.src is a full URL, so check if it contains the index filename
                    // For other projects, app.src is just a filename, so do exact match
                    if (window._isMoh93Project) {
                        // Check if URL contains the index filename (e.g., "_work-index.md")
                        var indexFileName = indexFileLower.replace('../', '').replace('./', '');
                        if (srcLower.includes(indexFileName)) {
                            isRootPage = true;
                        }
                    } else {
                        // Exact match for non-moh93 projects
                        if (srcLower == indexFileLower) {
                            isRootPage = true;
                        }
                    }
                    return isRootPage;
                }
            }

            run()

        } //window.load
    </script>

    <!-- moh, 24/6/24. Scripts that can be handled by pure jQuery, and not needed to be inside window.load -->
    <script>
        $(document).ready(function () {
            console.log('history:', getHistoryArray());
        });

        $(window).on('load', function () {
            //dom not only ready, but everything is loaded
        });

        $(document).on('click', 'a', function () {
            var href = $(this).prop('href');
            if (href.includes('.md')) {
                addHistoryItem(href);
            }
        });

        // MOH, 15/7/25, hotkey for image folder. No error, but not working.
        $(document).on('click', '.btn-image-folder', function () {
            console.log('btn-image-folder clicked');
            // Simulate Ctrl+Caps key combination
            simulateCtrlCaps();
        });


        // Convert top to below to trigger 404 error
        // filePath:    ../_LoadingDocuments/./aws-file-upload-jubo.md
        // urlMdHtm:    http://127.0.0.1:5500/md/md.htm?src=../_LoadingDocuments/./aws-file-upload-jubo.md
        // urlOrg:      http://127.0.0.1:5500/../_LoadingDocuments/./aws-file-upload-jubo.md

        function UrlExists(filePath) {
            console.log('filePath:', filePath);

            var urlMdHtm = window.location.href;
            var urlOrg;
            
            // Check if filePath is already a full URL (starts with http:// or https://)
            if (filePath.startsWith('http://') || filePath.startsWith('https://')) {
                // It's already a full URL, use it directly
                urlOrg = filePath;
            } else {
                // Fix: Construct proper URL with hostname and port
                var baseUrl = window.location.protocol + '//' + window.location.host;
                urlOrg = baseUrl + '/' + filePath;
            }

            console.log('urlMdHtm:', urlMdHtm);
            console.log('urlOrg:', urlOrg);

            // check file exists with urlOrg
            //`urlMdHtm` cannot be used to check file exists, it will not raise error because md.htm is valid url.
            var http = new XMLHttpRequest();
            http.open('HEAD', urlOrg, false);
            http.send();
            console.log('http.status:', http.status);

            if (http.status == 404) {
                alert('file not found: ' + urlOrg);
            }
            else {
                return true;
            }
        }

        // delete local storage
        function RemoveHistoryItem() {
            localStorage.removeItem(_clickHistory);
            location.reload();
        }

        // Show all local storage
        // https://stackoverflow.com/questions/17745292/how-to-retrieve-all-localstorage-items-without-knowing-the-keys-in-advance

        function allStorage() {
            var archive = [],
                keys = Object.keys(localStorage),
                i = 0, key;
            for (; key = keys[i]; i++) {
                archive.push(key + '=' + localStorage.getItem(key));
            }
            return archive;
        }

        function addHistoryItem(tmpHref) {
            // Check if tmpHref contains 127.0.0.1
            if (!tmpHref.includes('127.0.0.1')) {
                return false;
            }

            var array = getHistoryArray();
            removeItemAll(array, tmpHref);

            console.log('array2:', array);

            // add to end
            array.push(tmpHref);

            //Task last 5 items only
            var newArray = array.slice(-5);
            localStorage.setItem(_clickHistory, newArray.toString());
        }

        function removeItemAll(arr, value) {
            var i = 0;
            while (i < arr.length) {
                if (arr[i] === value) {
                    arr.splice(i, 1);
                } else {
                    ++i;
                }
            }
            return arr;
        }

        function getHistoryArray() {
            var strArray = localStorage.getItem(_clickHistory);
            var array = [];
            if (strArray != null) {
                array = strArray.split(',').map(function (item) {
                    return item;
                });
            }
            return array;
        }

        function getHistoryArrayHtml() {
            var div = '<div>';
            var array = getHistoryArray();

            for (var i = 0; i < array.length; i++) {
                var url = array[i];
                var filename = '';
                
                // Check if URL is in md.htm?src=... format
                if (url.includes('md.htm?src=')) {
                    // Extract the src parameter
                    var srcIndex = url.indexOf('src=');
                    if (srcIndex >= 0) {
                        var srcValue = url.substring(srcIndex + 4);
                        // Decode URL encoding
                        try {
                            srcValue = decodeURIComponent(srcValue);
                        } catch (e) {
                            // If decoding fails, use as-is
                        }
                        // Extract filename from path (handle both ../path/file.md and path/file.md)
                        var pathParts = srcValue.split('/');
                        filename = pathParts[pathParts.length - 1];
                    }
                } else {
                    // For regular URLs, extract filename from path
                    filename = url.split('/').pop();
                    // Remove query string and hash if present
                    filename = filename.split('?')[0].split('#')[0];
                }
                
                // Fallback to URL if filename extraction failed
                if (!filename || filename === '') {
                    filename = url;
                }
                
                div = div + `<li><a href="${url}">${filename}</a></li>`;
            }
            div = div + '</div>';
            return div;
        }

        /* hotkeys: Ctrl+CapsLock */

        function simulateCtrlCaps() {
            // Create and dispatch the keydown event
            const keydownEvent = new KeyboardEvent('keydown', {
                key: 'CapsLock',
                code: 'CapsLock',
                ctrlKey: true,
                bubbles: true,
                cancelable: true
            });

            // Create and dispatch the keyup event
            const keyupEvent = new KeyboardEvent('keyup', {
                key: 'CapsLock',
                code: 'CapsLock',
                ctrlKey: true,
                bubbles: true,
                cancelable: true
            });

            // Dispatch events
            document.dispatchEvent(keydownEvent);
            document.dispatchEvent(keyupEvent);

        }

        // Listen for the simulated event
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'CapsLock') {
                console.log('Ctrl+Caps detected!');
                // Your custom logic here
            }
        });
    </script>

</html>